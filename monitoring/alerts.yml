# Prometheus Alert Rules for TailorJob
groups:
  - name: tailorjob_critical
    interval: 30s
    rules:
      # Site Down Alert
      - alert: SiteDown
        expr: up{job="tailorjob-api"} == 0
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "üö® TailorJob API is DOWN"
          description: "The TailorJob API has been unreachable for more than 2 minutes."
          action: "Check Azure App Service status immediately"

      # High Error Rate
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "üö® High API Error Rate (>5%)"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"
          action: "Check Application Insights logs"

      # Payment System Issues
      - alert: PayPalHighFailureRate
        expr: |
          (
            sum(rate(paypal_api_calls_total{status="error"}[10m]))
            /
            sum(rate(paypal_api_calls_total[10m]))
          ) > 0.1
        for: 5m
        labels:
          severity: critical
          team: payments
        annotations:
          summary: "üö® PayPal API Failure Rate >10%"
          description: "PayPal integration is failing {{ $value | humanizePercentage }} of requests"
          action: "Check PayPal dashboard and webhook logs"

  - name: tailorjob_performance
    interval: 1m
    rules:
      # High API Latency
      - alert: HighAPILatency
        expr: |
          histogram_quantile(0.95,
            rate(http_request_duration_seconds_bucket[5m])
          ) > 2
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "‚ö†Ô∏è API Latency High (p95 > 2s)"
          description: "95th percentile latency is {{ $value }}s over the last 10 minutes"
          action: "Check slow queries in Application Insights"

      # CV Parse Queue Backed Up
      - alert: CVParseQueueBacklog
        expr: queue_length > 50
        for: 15m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "‚ö†Ô∏è CV Parse Queue Backed Up"
          description: "{{ $value }} CVs waiting to be parsed for 15+ minutes"
          action: "Check Redis connection and worker status"

  - name: tailorjob_business
    interval: 5m
    rules:
      # No Signups in 24 Hours
      - alert: ZeroSignupsLongPeriod
        expr: |
          increase(http_requests_total{endpoint="/api/auth/signup"}[24h]) == 0
        for: 1h
        labels:
          severity: info
          team: growth
        annotations:
          summary: "üìä No New Signups in 24 Hours"
          description: "No new user registrations detected in the last 24 hours"
          action: "Check marketing campaigns and signup flow"

      # Subscription Cancellation Spike
      - alert: HighCancellationRate
        expr: |
          rate(paypal_api_calls_total{operation="cancel_subscription"}[1h]) > 2
        for: 30m
        labels:
          severity: warning
          team: growth
        annotations:
          summary: "‚ö†Ô∏è High Subscription Cancellation Rate"
          description: "More than 2 cancellations per hour detected"
          action: "Review user feedback and recent changes"

  - name: tailorjob_resources
    interval: 1m
    rules:
      # High Memory Usage (if you add node_exporter)
      - alert: HighMemoryUsage
        expr: |
          (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)
          /
          node_memory_MemTotal_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "‚ö†Ô∏è High Memory Usage (>90%)"
          description: "Memory usage is at {{ $value | humanizePercentage }}"
          action: "Check for memory leaks or scale up instance"

      # Redis Connection Issues
      - alert: RedisConnectionErrors
        expr: rate(redis_connection_errors_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "‚ö†Ô∏è Redis Connection Errors"
          description: "Experiencing Redis connection issues"
          action: "Check Upstash Redis status and connection string"